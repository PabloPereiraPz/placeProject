import{A as we,B as ye,Ba as P,C as v,Ca as j,D as se,Da as Ae,E as ve,Ea as Ee,I as be,Ja as Pe,K as Se,M as Te,V as Ie,d as U,e as ee,f as le,g as b,h as B,i as ue,j as V,k as de,l as fe,n as ge,o as S,p as me,q as L,r as pe,s as ke,t as $,ta as Ce,u as q,v as _e,w as te,xa as xe,z as C}from"./chunk-E2IYHHLH.js";var J=class{validateSignature(i){return Promise.resolve(null)}validateAtHash(i){return Promise.resolve(!0)}},z=class{};var D=class{},Oe=(()=>{class o extends D{now(){return Date.now()}new(){return new Date}static{this.\u0275fac=(()=>{let e;return function(s){return(e||(e=be(o)))(s||o)}})()}static{this.\u0275prov=C({token:o,factory:o.\u0275fac})}}return o})();var Q=class{},K=class{},Me=(()=>{class o{constructor(){this.data=new Map}getItem(e){return this.data.get(e)}removeItem(e){this.data.delete(e)}setItem(e,t){this.data.set(e,t)}static{this.\u0275fac=function(t){return new(t||o)}}static{this.\u0275prov=C({token:o,factory:o.\u0275fac})}}return o})();var N=class{constructor(i){this.type=i}},y=class extends N{constructor(i,e=null){super(i),this.info=e}},T=class extends N{constructor(i,e=null){super(i),this.info=e}},p=class extends N{constructor(i,e,t=null){super(i),this.reason=e,this.params=t}};function Fe(o){let i=o.replace(/-/g,"+").replace(/_/g,"/");return decodeURIComponent(atob(i).split("").map(function(e){return"%"+("00"+e.charCodeAt(0).toString(16)).slice(-2)}).join(""))}function Ue(o){return btoa(o).replace(/\+/g,"-").replace(/\//g,"_").replace(/=/g,"")}var H=class{constructor(i){this.clientId="",this.redirectUri="",this.postLogoutRedirectUri="",this.redirectUriAsPostLogoutRedirectUriFallback=!0,this.loginUrl="",this.scope="openid profile",this.resource="",this.rngUrl="",this.oidc=!0,this.requestAccessToken=!0,this.options=null,this.issuer="",this.logoutUrl="",this.clearHashAfterLogin=!0,this.tokenEndpoint=null,this.revocationEndpoint=null,this.customTokenParameters=[],this.userinfoEndpoint=null,this.responseType="",this.showDebugInformation=!1,this.silentRefreshRedirectUri="",this.silentRefreshMessagePrefix="",this.silentRefreshShowIFrame=!1,this.siletRefreshTimeout=1e3*20,this.silentRefreshTimeout=1e3*20,this.dummyClientSecret="",this.requireHttps="remoteOnly",this.strictDiscoveryDocumentValidation=!0,this.jwks=null,this.customQueryParams=null,this.silentRefreshIFrameName="angular-oauth-oidc-silent-refresh-iframe",this.timeoutFactor=.75,this.sessionChecksEnabled=!1,this.sessionCheckIntervall=3*1e3,this.sessionCheckIFrameUrl=null,this.sessionCheckIFrameName="angular-oauth-oidc-check-session-iframe",this.disableAtHashCheck=!1,this.skipSubjectCheck=!1,this.useIdTokenHintForSilentRefresh=!1,this.skipIssuerCheck=!1,this.nonceStateSeparator=";",this.useHttpBasicAuth=!1,this.decreaseExpirationBySec=0,this.waitForTokenInMsec=0,this.disablePKCE=!1,this.preserveRequestedRoute=!1,this.disableIdTokenTimer=!1,this.checkOrigin=!1,this.openUri=e=>{location.href=e},i&&Object.assign(this,i)}},F=class{encodeKey(i){return encodeURIComponent(i)}encodeValue(i){return encodeURIComponent(i)}decodeKey(i){return decodeURIComponent(i)}decodeValue(i){return decodeURIComponent(i)}},W=class{};var Le=(()=>{class o{getHashFragmentParams(e){let t=e||window.location.hash;if(t=decodeURIComponent(t),t.indexOf("#")!==0)return{};let s=t.indexOf("?");return s>-1?t=t.substr(s+1):t=t.substr(1),this.parseQueryString(t)}parseQueryString(e){let t={},s,r,n,a,h,l;if(e===null)return t;let m=e.split("&");for(let c=0;c<m.length;c++)s=m[c],r=s.indexOf("="),r===-1?(n=s,a=null):(n=s.substr(0,r),a=s.substr(r+1)),h=decodeURIComponent(n),l=decodeURIComponent(a),h.substr(0,1)==="/"&&(h=h.substr(1)),t[h]=l;return t}static{this.\u0275fac=function(t){return new(t||o)}}static{this.\u0275prov=C({token:o,factory:o.\u0275fac})}}return o})(),je=32,Be=64,Ve=new Uint32Array([1116352408,1899447441,3049323471,3921009573,961987163,1508970993,2453635748,2870763221,3624381080,310598401,607225278,1426881987,1925078388,2162078206,2614888103,3248222580,3835390401,4022224774,264347078,604807628,770255983,1249150122,1555081692,1996064986,2554220882,2821834349,2952996808,3210313671,3336571891,3584528711,113926993,338241895,666307205,773529912,1294757372,1396182291,1695183700,1986661051,2177026350,2456956037,2730485921,2820302411,3259730800,3345764771,3516065817,3600352804,4094571909,275423344,430227734,506948616,659060556,883997877,958139571,1322822218,1537002063,1747873779,1955562222,2024104815,2227730452,2361852424,2428436474,2756734187,3204031479,3329325298]);function ie(o,i,e,t,s){let r,n,a,h,l,m,c,d,u,f,w,E,I;for(;s>=64;){for(r=i[0],n=i[1],a=i[2],h=i[3],l=i[4],m=i[5],c=i[6],d=i[7],f=0;f<16;f++)w=t+f*4,o[f]=(e[w]&255)<<24|(e[w+1]&255)<<16|(e[w+2]&255)<<8|e[w+3]&255;for(f=16;f<64;f++)u=o[f-2],E=(u>>>17|u<<15)^(u>>>19|u<<13)^u>>>10,u=o[f-15],I=(u>>>7|u<<25)^(u>>>18|u<<14)^u>>>3,o[f]=(E+o[f-7]|0)+(I+o[f-16]|0);for(f=0;f<64;f++)E=(((l>>>6|l<<26)^(l>>>11|l<<21)^(l>>>25|l<<7))+(l&m^~l&c)|0)+(d+(Ve[f]+o[f]|0)|0)|0,I=((r>>>2|r<<30)^(r>>>13|r<<19)^(r>>>22|r<<10))+(r&n^r&a^n&a)|0,d=c,c=m,m=l,l=h+E|0,h=a,a=n,n=r,r=E+I|0;i[0]+=r,i[1]+=n,i[2]+=a,i[3]+=h,i[4]+=l,i[5]+=m,i[6]+=c,i[7]+=d,t+=64,s-=64}return t}var re=class{constructor(){this.digestLength=je,this.blockSize=Be,this.state=new Int32Array(8),this.temp=new Int32Array(64),this.buffer=new Uint8Array(128),this.bufferLength=0,this.bytesHashed=0,this.finished=!1,this.reset()}reset(){return this.state[0]=1779033703,this.state[1]=3144134277,this.state[2]=1013904242,this.state[3]=2773480762,this.state[4]=1359893119,this.state[5]=2600822924,this.state[6]=528734635,this.state[7]=1541459225,this.bufferLength=0,this.bytesHashed=0,this.finished=!1,this}clean(){for(let i=0;i<this.buffer.length;i++)this.buffer[i]=0;for(let i=0;i<this.temp.length;i++)this.temp[i]=0;this.reset()}update(i,e=i.length){if(this.finished)throw new Error("SHA256: can't update because hash was finished.");let t=0;if(this.bytesHashed+=e,this.bufferLength>0){for(;this.bufferLength<64&&e>0;)this.buffer[this.bufferLength++]=i[t++],e--;this.bufferLength===64&&(ie(this.temp,this.state,this.buffer,0,64),this.bufferLength=0)}for(e>=64&&(t=ie(this.temp,this.state,i,t,e),e%=64);e>0;)this.buffer[this.bufferLength++]=i[t++],e--;return this}finish(i){if(!this.finished){let e=this.bytesHashed,t=this.bufferLength,s=e/536870912|0,r=e<<3,n=e%64<56?64:128;this.buffer[t]=128;for(let a=t+1;a<n-8;a++)this.buffer[a]=0;this.buffer[n-8]=s>>>24&255,this.buffer[n-7]=s>>>16&255,this.buffer[n-6]=s>>>8&255,this.buffer[n-5]=s>>>0&255,this.buffer[n-4]=r>>>24&255,this.buffer[n-3]=r>>>16&255,this.buffer[n-2]=r>>>8&255,this.buffer[n-1]=r>>>0&255,ie(this.temp,this.state,this.buffer,0,n),this.finished=!0}for(let e=0;e<8;e++)i[e*4+0]=this.state[e]>>>24&255,i[e*4+1]=this.state[e]>>>16&255,i[e*4+2]=this.state[e]>>>8&255,i[e*4+3]=this.state[e]>>>0&255;return this}digest(){let i=new Uint8Array(this.digestLength);return this.finish(i),i}_saveState(i){for(let e=0;e<this.state.length;e++)i[e]=this.state[e]}_restoreState(i,e){for(let t=0;t<this.state.length;t++)this.state[t]=i[t];this.bytesHashed=e,this.finished=!1,this.bufferLength=0}};function $e(o){let i=new re().update(o),e=i.digest();return i.clean(),e}var ut=new Uint8Array(je);var X=class{};function qe(o){if(typeof o!="string")throw new TypeError("expected string");let i=o,e=new Uint8Array(i.length);for(let t=0;t<i.length;t++)e[t]=i.charCodeAt(t);return e}function Je(o){let i=[];for(let e=0;e<o.length;e++)i.push(String.fromCharCode(o[e]));return i.join("")}var ze=(()=>{class o{calcHash(e,t){return U(this,null,function*(){return Je($e(qe(e)))})}toHashString2(e){let t="";for(let s of e)t+=String.fromCharCode(s);return t}toHashString(e){let t=new Uint8Array(e),s="";for(let r of t)s+=String.fromCharCode(r);return s}static{this.\u0275fac=function(t){return new(t||o)}}static{this.\u0275prov=C({token:o,factory:o.\u0275fac})}}return o})(),G=(()=>{class o extends H{constructor(e,t,s,r,n,a,h,l,m,c){super(),this.ngZone=e,this.http=t,this.config=n,this.urlHelper=a,this.logger=h,this.crypto=l,this.dateTimeService=c,this.discoveryDocumentLoaded=!1,this.state="",this.eventsSubject=new ee,this.discoveryDocumentLoadedSubject=new ee,this.grantTypesSupported=[],this.inImplicitFlow=!1,this.saveNoncesInLocalStorage=!1,this.debug("angular-oauth2-oidc v10"),this.document=m,n||(n={}),this.discoveryDocumentLoaded$=this.discoveryDocumentLoadedSubject.asObservable(),this.events=this.eventsSubject.asObservable(),r&&(this.tokenValidationHandler=r),n&&this.configure(n);try{s?this.setStorage(s):typeof sessionStorage<"u"&&this.setStorage(sessionStorage)}catch(d){console.error("No OAuthStorage provided and cannot access default (sessionStorage).Consider providing a custom OAuthStorage implementation in your module.",d)}if(this.checkLocalStorageAccessable()){let d=window?.navigator?.userAgent;(d?.includes("MSIE ")||d?.includes("Trident"))&&(this.saveNoncesInLocalStorage=!0)}this.setupRefreshTimer()}checkLocalStorageAccessable(){if(typeof window>"u")return!1;let e="test";try{return typeof window.localStorage>"u"?!1:(localStorage.setItem(e,e),localStorage.removeItem(e),!0)}catch{return!1}}configure(e){Object.assign(this,new H,e),this.config=Object.assign({},new H,e),this.sessionChecksEnabled&&this.setupSessionCheck(),this.configChanged()}configChanged(){this.setupRefreshTimer()}restartSessionChecksIfStillLoggedIn(){this.hasValidIdToken()&&this.initSessionCheck()}restartRefreshTimerIfStillLoggedIn(){this.setupExpirationTimers()}setupSessionCheck(){this.events.pipe(S(e=>e.type==="token_received")).subscribe(()=>{this.initSessionCheck()})}setupAutomaticSilentRefresh(e={},t,s=!0){let r=!0;this.clearAutomaticRefreshTimer(),this.automaticRefreshSubscription=this.events.pipe(te(n=>{n.type==="token_received"?r=!0:n.type==="logout"&&(r=!1)}),S(n=>n.type==="token_expires"&&(t==null||t==="any"||n.info===t)),pe(1e3)).subscribe(()=>{r&&this.refreshInternal(e,s).catch(()=>{this.debug("Automatic silent refresh did not work")})}),this.restartRefreshTimerIfStillLoggedIn()}refreshInternal(e,t){return!this.useSilentRefresh&&this.responseType==="code"?this.refreshToken():this.silentRefresh(e,t)}loadDiscoveryDocumentAndTryLogin(e=null){return this.loadDiscoveryDocument().then(()=>this.tryLogin(e))}loadDiscoveryDocumentAndLogin(e=null){return e=e||{},this.loadDiscoveryDocumentAndTryLogin(e).then(()=>{if(!this.hasValidIdToken()||!this.hasValidAccessToken()){let t=typeof e.state=="string"?e.state:"";return this.initLoginFlow(t),!1}else return!0})}debug(...e){this.showDebugInformation&&this.logger.debug(...e)}validateUrlFromDiscoveryDocument(e){let t=[],s=this.validateUrlForHttps(e),r=this.validateUrlAgainstIssuer(e);return s||t.push("https for all urls required. Also for urls received by discovery."),r||t.push("Every url in discovery document has to start with the issuer url.Also see property strictDiscoveryDocumentValidation."),t}validateUrlForHttps(e){if(!e)return!0;let t=e.toLowerCase();return this.requireHttps===!1||(t.match(/^http:\/\/localhost($|[:/])/)||t.match(/^http:\/\/localhost($|[:/])/))&&this.requireHttps==="remoteOnly"?!0:t.startsWith("https://")}assertUrlNotNullAndCorrectProtocol(e,t){if(!e)throw new Error(`'${t}' should not be null`);if(!this.validateUrlForHttps(e))throw new Error(`'${t}' must use HTTPS (with TLS), or config value for property 'requireHttps' must be set to 'false' and allow HTTP (without TLS).`)}validateUrlAgainstIssuer(e){return!this.strictDiscoveryDocumentValidation||!e?!0:e.toLowerCase().startsWith(this.issuer.toLowerCase())}setupRefreshTimer(){if(typeof window>"u"){this.debug("timer not supported on this plattform");return}(this.hasValidIdToken()||this.hasValidAccessToken())&&(this.clearAccessTokenTimer(),this.clearIdTokenTimer(),this.setupExpirationTimers()),this.tokenReceivedSubscription&&this.tokenReceivedSubscription.unsubscribe(),this.tokenReceivedSubscription=this.events.pipe(S(e=>e.type==="token_received")).subscribe(()=>{this.clearAccessTokenTimer(),this.clearIdTokenTimer(),this.setupExpirationTimers()})}setupExpirationTimers(){this.hasValidAccessToken()&&this.setupAccessTokenTimer(),!this.disableIdTokenTimer&&this.hasValidIdToken()&&this.setupIdTokenTimer()}setupAccessTokenTimer(){let e=this.getAccessTokenExpiration(),t=this.getAccessTokenStoredAt(),s=this.calcTimeout(t,e);this.ngZone.runOutsideAngular(()=>{this.accessTokenTimeoutSubscription=b(new T("token_expires","access_token")).pipe($(s)).subscribe(r=>{this.ngZone.run(()=>{this.eventsSubject.next(r)})})})}setupIdTokenTimer(){let e=this.getIdTokenExpiration(),t=this.getIdTokenStoredAt(),s=this.calcTimeout(t,e);this.ngZone.runOutsideAngular(()=>{this.idTokenTimeoutSubscription=b(new T("token_expires","id_token")).pipe($(s)).subscribe(r=>{this.ngZone.run(()=>{this.eventsSubject.next(r)})})})}stopAutomaticRefresh(){this.clearAccessTokenTimer(),this.clearIdTokenTimer(),this.clearAutomaticRefreshTimer()}clearAccessTokenTimer(){this.accessTokenTimeoutSubscription&&this.accessTokenTimeoutSubscription.unsubscribe()}clearIdTokenTimer(){this.idTokenTimeoutSubscription&&this.idTokenTimeoutSubscription.unsubscribe()}clearAutomaticRefreshTimer(){this.automaticRefreshSubscription&&this.automaticRefreshSubscription.unsubscribe()}calcTimeout(e,t){let s=this.dateTimeService.now(),r=(t-e)*this.timeoutFactor-(s-e),n=Math.max(0,r),a=2147483647;return n>a?a:n}setStorage(e){this._storage=e,this.configChanged()}loadDiscoveryDocument(e=null){return new Promise((t,s)=>{if(e||(e=this.issuer||"",e.endsWith("/")||(e+="/"),e+=".well-known/openid-configuration"),!this.validateUrlForHttps(e)){s("issuer  must use HTTPS (with TLS), or config value for property 'requireHttps' must be set to 'false' and allow HTTP (without TLS).");return}this.http.get(e).subscribe(r=>{if(!this.validateDiscoveryDocument(r)){this.eventsSubject.next(new p("discovery_document_validation_error",null)),s("discovery_document_validation_error");return}this.loginUrl=r.authorization_endpoint,this.logoutUrl=r.end_session_endpoint||this.logoutUrl,this.grantTypesSupported=r.grant_types_supported,this.issuer=r.issuer,this.tokenEndpoint=r.token_endpoint,this.userinfoEndpoint=r.userinfo_endpoint||this.userinfoEndpoint,this.jwksUri=r.jwks_uri,this.sessionCheckIFrameUrl=r.check_session_iframe||this.sessionCheckIFrameUrl,this.discoveryDocumentLoaded=!0,this.discoveryDocumentLoadedSubject.next(r),this.revocationEndpoint=r.revocation_endpoint||this.revocationEndpoint,this.sessionChecksEnabled&&this.restartSessionChecksIfStillLoggedIn(),this.loadJwks().then(n=>{let a={discoveryDocument:r,jwks:n},h=new y("discovery_document_loaded",a);this.eventsSubject.next(h),t(h)}).catch(n=>{this.eventsSubject.next(new p("discovery_document_load_error",n)),s(n)})},r=>{this.logger.error("error loading discovery document",r),this.eventsSubject.next(new p("discovery_document_load_error",r)),s(r)})})}loadJwks(){return new Promise((e,t)=>{this.jwksUri?this.http.get(this.jwksUri).subscribe(s=>{this.jwks=s,e(s)},s=>{this.logger.error("error loading jwks",s),this.eventsSubject.next(new p("jwks_load_error",s)),t(s)}):e(null)})}validateDiscoveryDocument(e){let t;return!this.skipIssuerCheck&&e.issuer!==this.issuer?(this.logger.error("invalid issuer in discovery document","expected: "+this.issuer,"current: "+e.issuer),!1):(t=this.validateUrlFromDiscoveryDocument(e.authorization_endpoint),t.length>0?(this.logger.error("error validating authorization_endpoint in discovery document",t),!1):(t=this.validateUrlFromDiscoveryDocument(e.end_session_endpoint),t.length>0?(this.logger.error("error validating end_session_endpoint in discovery document",t),!1):(t=this.validateUrlFromDiscoveryDocument(e.token_endpoint),t.length>0&&this.logger.error("error validating token_endpoint in discovery document",t),t=this.validateUrlFromDiscoveryDocument(e.revocation_endpoint),t.length>0&&this.logger.error("error validating revocation_endpoint in discovery document",t),t=this.validateUrlFromDiscoveryDocument(e.userinfo_endpoint),t.length>0?(this.logger.error("error validating userinfo_endpoint in discovery document",t),!1):(t=this.validateUrlFromDiscoveryDocument(e.jwks_uri),t.length>0?(this.logger.error("error validating jwks_uri in discovery document",t),!1):(this.sessionChecksEnabled&&!e.check_session_iframe&&this.logger.warn("sessionChecksEnabled is activated but discovery document does not contain a check_session_iframe field"),!0)))))}fetchTokenUsingPasswordFlowAndLoadUserProfile(e,t,s=new P){return this.fetchTokenUsingPasswordFlow(e,t,s).then(()=>this.loadUserProfile())}loadUserProfile(){if(!this.hasValidAccessToken())throw new Error("Can not load User Profile without access_token");if(!this.validateUrlForHttps(this.userinfoEndpoint))throw new Error("userinfoEndpoint must use HTTPS (with TLS), or config value for property 'requireHttps' must be set to 'false' and allow HTTP (without TLS).");return new Promise((e,t)=>{let s=new P().set("Authorization","Bearer "+this.getAccessToken());this.http.get(this.userinfoEndpoint,{headers:s,observe:"response",responseType:"text"}).subscribe(r=>{if(this.debug("userinfo received",JSON.stringify(r)),r.headers.get("content-type").startsWith("application/json")){let n=JSON.parse(r.body),a=this.getIdentityClaims()||{};if(!this.skipSubjectCheck&&this.oidc&&(!a.sub||n.sub!==a.sub)){t(`if property oidc is true, the received user-id (sub) has to be the user-id of the user that has logged in with oidc.
if you are not using oidc but just oauth2 password flow set oidc to false`);return}n=Object.assign({},a,n),this._storage.setItem("id_token_claims_obj",JSON.stringify(n)),this.eventsSubject.next(new y("user_profile_loaded")),e({info:n})}else this.debug("userinfo is not JSON, treating it as JWE/JWS"),this.eventsSubject.next(new y("user_profile_loaded")),e(JSON.parse(r.body))},r=>{this.logger.error("error loading user info",r),this.eventsSubject.next(new p("user_profile_load_error",r)),t(r)})})}fetchTokenUsingPasswordFlow(e,t,s=new P){let r={username:e,password:t};return this.fetchTokenUsingGrant("password",r,s)}fetchTokenUsingGrant(e,t,s=new P){this.assertUrlNotNullAndCorrectProtocol(this.tokenEndpoint,"tokenEndpoint");let r=new j({encoder:new F}).set("grant_type",e).set("scope",this.scope);if(this.useHttpBasicAuth){let n=btoa(`${this.clientId}:${this.dummyClientSecret}`);s=s.set("Authorization","Basic "+n)}if(this.useHttpBasicAuth||(r=r.set("client_id",this.clientId)),!this.useHttpBasicAuth&&this.dummyClientSecret&&(r=r.set("client_secret",this.dummyClientSecret)),this.customQueryParams)for(let n of Object.getOwnPropertyNames(this.customQueryParams))r=r.set(n,this.customQueryParams[n]);for(let n of Object.keys(t))r=r.set(n,t[n]);return s=s.set("Content-Type","application/x-www-form-urlencoded"),new Promise((n,a)=>{this.http.post(this.tokenEndpoint,r,{headers:s}).subscribe(h=>{this.debug("tokenResponse",h),this.storeAccessTokenResponse(h.access_token,h.refresh_token,h.expires_in||this.fallbackAccessTokenExpirationTimeInSec,h.scope,this.extractRecognizedCustomParameters(h)),this.oidc&&h.id_token&&this.processIdToken(h.id_token,h.access_token).then(l=>{this.storeIdToken(l),n(h)}),this.eventsSubject.next(new y("token_received")),n(h)},h=>{this.logger.error("Error performing ${grantType} flow",h),this.eventsSubject.next(new p("token_error",h)),a(h)})})}refreshToken(){return this.assertUrlNotNullAndCorrectProtocol(this.tokenEndpoint,"tokenEndpoint"),new Promise((e,t)=>{let s=new j({encoder:new F}).set("grant_type","refresh_token").set("scope",this.scope).set("refresh_token",this._storage.getItem("refresh_token")),r=new P().set("Content-Type","application/x-www-form-urlencoded");if(this.useHttpBasicAuth){let n=btoa(`${this.clientId}:${this.dummyClientSecret}`);r=r.set("Authorization","Basic "+n)}if(this.useHttpBasicAuth||(s=s.set("client_id",this.clientId)),!this.useHttpBasicAuth&&this.dummyClientSecret&&(s=s.set("client_secret",this.dummyClientSecret)),this.customQueryParams)for(let n of Object.getOwnPropertyNames(this.customQueryParams))s=s.set(n,this.customQueryParams[n]);this.http.post(this.tokenEndpoint,s,{headers:r}).pipe(_e(n=>this.oidc&&n.id_token?le(this.processIdToken(n.id_token,n.access_token,!0)).pipe(te(a=>this.storeIdToken(a)),V(()=>n)):b(n))).subscribe(n=>{this.debug("refresh tokenResponse",n),this.storeAccessTokenResponse(n.access_token,n.refresh_token,n.expires_in||this.fallbackAccessTokenExpirationTimeInSec,n.scope,this.extractRecognizedCustomParameters(n)),this.eventsSubject.next(new y("token_received")),this.eventsSubject.next(new y("token_refreshed")),e(n)},n=>{this.logger.error("Error refreshing token",n),this.eventsSubject.next(new p("token_refresh_error",n)),t(n)})})}removeSilentRefreshEventListener(){this.silentRefreshPostMessageEventListener&&(window.removeEventListener("message",this.silentRefreshPostMessageEventListener),this.silentRefreshPostMessageEventListener=null)}setupSilentRefreshEventListener(){this.removeSilentRefreshEventListener(),this.silentRefreshPostMessageEventListener=e=>{let t=this.processMessageEventMessage(e);this.checkOrigin&&e.origin!==location.origin&&console.error("wrong origin requested silent refresh!"),this.tryLogin({customHashFragment:t,preventClearHashAfterLogin:!0,customRedirectUri:this.silentRefreshRedirectUri||this.redirectUri}).catch(s=>this.debug("tryLogin during silent refresh failed",s))},window.addEventListener("message",this.silentRefreshPostMessageEventListener)}silentRefresh(e={},t=!0){let s=this.getIdentityClaims()||{};if(this.useIdTokenHintForSilentRefresh&&this.hasValidIdToken()&&(e.id_token_hint=this.getIdToken()),!this.validateUrlForHttps(this.loginUrl))throw new Error("loginUrl  must use HTTPS (with TLS), or config value for property 'requireHttps' must be set to 'false' and allow HTTP (without TLS).");if(typeof this.document>"u")throw new Error("silent refresh is not supported on this platform");let r=this.document.getElementById(this.silentRefreshIFrameName);r&&this.document.body.removeChild(r),this.silentRefreshSubject=s.sub;let n=this.document.createElement("iframe");n.id=this.silentRefreshIFrameName,this.setupSilentRefreshEventListener();let a=this.silentRefreshRedirectUri||this.redirectUri;this.createLoginUrl(null,null,a,t,e).then(c=>{n.setAttribute("src",c),this.silentRefreshShowIFrame||(n.style.display="none"),this.document.body.appendChild(n)});let h=this.events.pipe(S(c=>c instanceof p),q()),l=this.events.pipe(S(c=>c.type==="token_received"),q()),m=b(new p("silent_refresh_timeout",null)).pipe($(this.silentRefreshTimeout));return me([h,l,m]).pipe(V(c=>{if(c instanceof p)throw c.type==="silent_refresh_timeout"?this.eventsSubject.next(c):(c=new p("silent_refresh_error",c),this.eventsSubject.next(c)),c;return c.type==="token_received"&&(c=new y("silently_refreshed"),this.eventsSubject.next(c)),c})).toPromise()}initImplicitFlowInPopup(e){return this.initLoginFlowInPopup(e)}initLoginFlowInPopup(e){return e=e||{},this.createLoginUrl(null,null,this.silentRefreshRedirectUri,!1,{display:"popup"}).then(t=>new Promise((s,r)=>{let a=null;e.windowRef?e.windowRef&&!e.windowRef.closed&&(a=e.windowRef,a.location.href=t):a=window.open(t,"ngx-oauth2-oidc-login",this.calculatePopupFeatures(e));let h,l=f=>{this.tryLogin({customHashFragment:f,preventClearHashAfterLogin:!0,customRedirectUri:this.silentRefreshRedirectUri}).then(()=>{c(),s(!0)},w=>{c(),r(w)})},m=()=>{(!a||a.closed)&&(c(),r(new p("popup_closed",{})))};a?h=window.setInterval(m,500):r(new p("popup_blocked",{}));let c=()=>{window.clearInterval(h),window.removeEventListener("storage",u),window.removeEventListener("message",d),a!==null&&a.close(),a=null},d=f=>{let w=this.processMessageEventMessage(f);w&&w!==null?(window.removeEventListener("storage",u),l(w)):console.log("false event firing")},u=f=>{f.key==="auth_hash"&&(window.removeEventListener("message",d),l(f.newValue))};window.addEventListener("message",d),window.addEventListener("storage",u)}))}calculatePopupFeatures(e){let t=e.height||470,s=e.width||500,r=window.screenLeft+(window.outerWidth-s)/2,n=window.screenTop+(window.outerHeight-t)/2;return`location=no,toolbar=no,width=${s},height=${t},top=${n},left=${r}`}processMessageEventMessage(e){let t="#";if(this.silentRefreshMessagePrefix&&(t+=this.silentRefreshMessagePrefix),!e||!e.data||typeof e.data!="string")return;let s=e.data;if(s.startsWith(t))return"#"+s.substr(t.length)}canPerformSessionCheck(){return this.sessionChecksEnabled?this.sessionCheckIFrameUrl?this.getSessionState()?!(typeof this.document>"u"):(console.warn("sessionChecksEnabled is activated but there is no session_state"),!1):(console.warn("sessionChecksEnabled is activated but there is no sessionCheckIFrameUrl"),!1):!1}setupSessionCheckEventListener(){this.removeSessionCheckEventListener(),this.sessionCheckEventListener=e=>{let t=e.origin.toLowerCase(),s=this.issuer.toLowerCase();if(this.debug("sessionCheckEventListener"),!s.startsWith(t)){this.debug("sessionCheckEventListener","wrong origin",t,"expected",s,"event",e);return}switch(e.data){case"unchanged":this.ngZone.run(()=>{this.handleSessionUnchanged()});break;case"changed":this.ngZone.run(()=>{this.handleSessionChange()});break;case"error":this.ngZone.run(()=>{this.handleSessionError()});break}this.debug("got info from session check inframe",e)},this.ngZone.runOutsideAngular(()=>{window.addEventListener("message",this.sessionCheckEventListener)})}handleSessionUnchanged(){this.debug("session check","session unchanged"),this.eventsSubject.next(new T("session_unchanged"))}handleSessionChange(){this.eventsSubject.next(new T("session_changed")),this.stopSessionCheckTimer(),!this.useSilentRefresh&&this.responseType==="code"?this.refreshToken().then(()=>{this.debug("token refresh after session change worked")}).catch(()=>{this.debug("token refresh did not work after session changed"),this.eventsSubject.next(new T("session_terminated")),this.logOut(!0)}):this.silentRefreshRedirectUri?(this.silentRefresh().catch(()=>this.debug("silent refresh failed after session changed")),this.waitForSilentRefreshAfterSessionChange()):(this.eventsSubject.next(new T("session_terminated")),this.logOut(!0))}waitForSilentRefreshAfterSessionChange(){this.events.pipe(S(e=>e.type==="silently_refreshed"||e.type==="silent_refresh_timeout"||e.type==="silent_refresh_error"),q()).subscribe(e=>{e.type!=="silently_refreshed"&&(this.debug("silent refresh did not work after session changed"),this.eventsSubject.next(new T("session_terminated")),this.logOut(!0))})}handleSessionError(){this.stopSessionCheckTimer(),this.eventsSubject.next(new T("session_error"))}removeSessionCheckEventListener(){this.sessionCheckEventListener&&(window.removeEventListener("message",this.sessionCheckEventListener),this.sessionCheckEventListener=null)}initSessionCheck(){if(!this.canPerformSessionCheck())return;let e=this.document.getElementById(this.sessionCheckIFrameName);e&&this.document.body.removeChild(e);let t=this.document.createElement("iframe");t.id=this.sessionCheckIFrameName,this.setupSessionCheckEventListener();let s=this.sessionCheckIFrameUrl;t.setAttribute("src",s),t.style.display="none",this.document.body.appendChild(t),this.startSessionCheckTimer()}startSessionCheckTimer(){this.stopSessionCheckTimer(),this.ngZone.runOutsideAngular(()=>{this.sessionCheckTimer=setInterval(this.checkSession.bind(this),this.sessionCheckIntervall)})}stopSessionCheckTimer(){this.sessionCheckTimer&&(clearInterval(this.sessionCheckTimer),this.sessionCheckTimer=null)}checkSession(){let e=this.document.getElementById(this.sessionCheckIFrameName);e||this.logger.warn("checkSession did not find iframe",this.sessionCheckIFrameName);let t=this.getSessionState();t||this.stopSessionCheckTimer();let s=this.clientId+" "+t;e.contentWindow.postMessage(s,this.issuer)}createLoginUrl(){return U(this,arguments,function*(e="",t="",s="",r=!1,n={}){let a=this,h;s?h=s:h=this.redirectUri;let l=yield this.createAndSaveNonce();if(e?e=l+this.config.nonceStateSeparator+encodeURIComponent(e):e=l,!this.requestAccessToken&&!this.oidc)throw new Error("Either requestAccessToken or oidc or both must be true");this.config.responseType?this.responseType=this.config.responseType:this.oidc&&this.requestAccessToken?this.responseType="id_token token":this.oidc&&!this.requestAccessToken?this.responseType="id_token":this.responseType="token";let m=a.loginUrl.indexOf("?")>-1?"&":"?",c=a.scope;this.oidc&&!c.match(/(^|\s)openid($|\s)/)&&(c="openid "+c);let d=a.loginUrl+m+"response_type="+encodeURIComponent(a.responseType)+"&client_id="+encodeURIComponent(a.clientId)+"&state="+encodeURIComponent(e)+"&redirect_uri="+encodeURIComponent(h)+"&scope="+encodeURIComponent(c);if(this.responseType.includes("code")&&!this.disablePKCE){let[u,f]=yield this.createChallangeVerifierPairForPKCE();this.saveNoncesInLocalStorage&&typeof window.localStorage<"u"?localStorage.setItem("PKCE_verifier",f):this._storage.setItem("PKCE_verifier",f),d+="&code_challenge="+u,d+="&code_challenge_method=S256"}t&&(d+="&login_hint="+encodeURIComponent(t)),a.resource&&(d+="&resource="+encodeURIComponent(a.resource)),a.oidc&&(d+="&nonce="+encodeURIComponent(l)),r&&(d+="&prompt=none");for(let u of Object.keys(n))d+="&"+encodeURIComponent(u)+"="+encodeURIComponent(n[u]);if(this.customQueryParams)for(let u of Object.getOwnPropertyNames(this.customQueryParams))d+="&"+u+"="+encodeURIComponent(this.customQueryParams[u]);return d})}initImplicitFlowInternal(e="",t=""){if(this.inImplicitFlow)return;if(this.inImplicitFlow=!0,!this.validateUrlForHttps(this.loginUrl))throw new Error("loginUrl  must use HTTPS (with TLS), or config value for property 'requireHttps' must be set to 'false' and allow HTTP (without TLS).");let s={},r=null;typeof t=="string"?r=t:typeof t=="object"&&(s=t),this.createLoginUrl(e,r,null,!1,s).then(this.config.openUri).catch(n=>{console.error("Error in initImplicitFlow",n),this.inImplicitFlow=!1})}initImplicitFlow(e="",t=""){this.loginUrl!==""?this.initImplicitFlowInternal(e,t):this.events.pipe(S(s=>s.type==="discovery_document_loaded")).subscribe(()=>this.initImplicitFlowInternal(e,t))}resetImplicitFlow(){this.inImplicitFlow=!1}callOnTokenReceivedIfExists(e){let t=this;if(e.onTokenReceived){let s={idClaims:t.getIdentityClaims(),idToken:t.getIdToken(),accessToken:t.getAccessToken(),state:t.state};e.onTokenReceived(s)}}storeAccessTokenResponse(e,t,s,r,n){if(this._storage.setItem("access_token",e),r&&!Array.isArray(r)?this._storage.setItem("granted_scopes",JSON.stringify(r.split(" "))):r&&Array.isArray(r)&&this._storage.setItem("granted_scopes",JSON.stringify(r)),this._storage.setItem("access_token_stored_at",""+this.dateTimeService.now()),s){let a=s*1e3,l=this.dateTimeService.new().getTime()+a;this._storage.setItem("expires_at",""+l)}t&&this._storage.setItem("refresh_token",t),n&&n.forEach((a,h)=>{this._storage.setItem(h,a)})}tryLogin(e=null){return this.config.responseType==="code"?this.tryLoginCodeFlow(e).then(()=>!0):this.tryLoginImplicitFlow(e)}parseQueryString(e){return!e||e.length===0?{}:(e.charAt(0)==="?"&&(e=e.substr(1)),this.urlHelper.parseQueryString(e))}tryLoginCodeFlow(e=null){return U(this,null,function*(){e=e||{};let t=e.customHashFragment?e.customHashFragment.substring(1):window.location.search,s=this.getCodePartsFromUrl(t),r=s.code,n=s.state,a=s.session_state;if(!e.preventClearHashAfterLogin){let m=location.origin+location.pathname+location.search.replace(/code=[^&$]*/,"").replace(/scope=[^&$]*/,"").replace(/state=[^&$]*/,"").replace(/session_state=[^&$]*/,"").replace(/^\?&/,"?").replace(/&$/,"").replace(/^\?$/,"").replace(/&+/g,"&").replace(/\?&/,"?").replace(/\?$/,"")+location.hash;history.replaceState(null,window.name,m)}let[h,l]=this.parseState(n);if(this.state=l,s.error){this.debug("error trying to login"),this.handleLoginError(e,s);let m=new p("code_error",{},s);return this.eventsSubject.next(m),Promise.reject(m)}if(!e.disableNonceCheck){if(!h)return this.saveRequestedRoute(),Promise.resolve();if(!e.disableOAuth2StateCheck&&!this.validateNonce(h)){let c=new p("invalid_nonce_in_state",null);return this.eventsSubject.next(c),Promise.reject(c)}}return this.storeSessionState(a),r&&(yield this.getTokenFromCode(r,e),this.restoreRequestedRoute()),Promise.resolve()})}saveRequestedRoute(){this.config.preserveRequestedRoute&&this._storage.setItem("requested_route",window.location.pathname+window.location.search)}restoreRequestedRoute(){let e=this._storage.getItem("requested_route");e&&history.replaceState(null,"",window.location.origin+e)}getCodePartsFromUrl(e){return!e||e.length===0?this.urlHelper.getHashFragmentParams():(e.charAt(0)==="?"&&(e=e.substr(1)),this.urlHelper.parseQueryString(e))}getTokenFromCode(e,t){let s=new j({encoder:new F}).set("grant_type","authorization_code").set("code",e).set("redirect_uri",t.customRedirectUri||this.redirectUri);if(!this.disablePKCE){let r;this.saveNoncesInLocalStorage&&typeof window.localStorage<"u"?r=localStorage.getItem("PKCE_verifier"):r=this._storage.getItem("PKCE_verifier"),r?s=s.set("code_verifier",r):console.warn("No PKCE verifier found in oauth storage!")}return this.fetchAndProcessToken(s,t)}fetchAndProcessToken(e,t){t=t||{},this.assertUrlNotNullAndCorrectProtocol(this.tokenEndpoint,"tokenEndpoint");let s=new P().set("Content-Type","application/x-www-form-urlencoded");if(this.useHttpBasicAuth){let r=btoa(`${this.clientId}:${this.dummyClientSecret}`);s=s.set("Authorization","Basic "+r)}return this.useHttpBasicAuth||(e=e.set("client_id",this.clientId)),!this.useHttpBasicAuth&&this.dummyClientSecret&&(e=e.set("client_secret",this.dummyClientSecret)),new Promise((r,n)=>{if(this.customQueryParams)for(let a of Object.getOwnPropertyNames(this.customQueryParams))e=e.set(a,this.customQueryParams[a]);this.http.post(this.tokenEndpoint,e,{headers:s}).subscribe(a=>{this.debug("refresh tokenResponse",a),this.storeAccessTokenResponse(a.access_token,a.refresh_token,a.expires_in||this.fallbackAccessTokenExpirationTimeInSec,a.scope,this.extractRecognizedCustomParameters(a)),this.oidc&&a.id_token?this.processIdToken(a.id_token,a.access_token,t.disableNonceCheck).then(h=>{this.storeIdToken(h),this.eventsSubject.next(new y("token_received")),this.eventsSubject.next(new y("token_refreshed")),r(a)}).catch(h=>{this.eventsSubject.next(new p("token_validation_error",h)),console.error("Error validating tokens"),console.error(h),n(h)}):(this.eventsSubject.next(new y("token_received")),this.eventsSubject.next(new y("token_refreshed")),r(a))},a=>{console.error("Error getting token",a),this.eventsSubject.next(new p("token_refresh_error",a)),n(a)})})}tryLoginImplicitFlow(e=null){e=e||{};let t;e.customHashFragment?t=this.urlHelper.getHashFragmentParams(e.customHashFragment):t=this.urlHelper.getHashFragmentParams(),this.debug("parsed url",t);let s=t.state,[r,n]=this.parseState(s);if(this.state=n,t.error){this.debug("error trying to login"),this.handleLoginError(e,t);let c=new p("token_error",{},t);return this.eventsSubject.next(c),Promise.reject(c)}let a=t.access_token,h=t.id_token,l=t.session_state,m=t.scope;if(!this.requestAccessToken&&!this.oidc)return Promise.reject("Either requestAccessToken or oidc (or both) must be true.");if(this.requestAccessToken&&!a||this.requestAccessToken&&!e.disableOAuth2StateCheck&&!s||this.oidc&&!h)return Promise.resolve(!1);if(this.sessionChecksEnabled&&!l&&this.logger.warn("session checks (Session Status Change Notification) were activated in the configuration but the id_token does not contain a session_state claim"),this.requestAccessToken&&!e.disableNonceCheck&&!this.validateNonce(r)){let d=new p("invalid_nonce_in_state",null);return this.eventsSubject.next(d),Promise.reject(d)}return this.requestAccessToken&&this.storeAccessTokenResponse(a,null,t.expires_in||this.fallbackAccessTokenExpirationTimeInSec,m),this.oidc?this.processIdToken(h,a,e.disableNonceCheck).then(c=>e.validationHandler?e.validationHandler({accessToken:a,idClaims:c.idTokenClaims,idToken:c.idToken,state:s}).then(()=>c):c).then(c=>(this.storeIdToken(c),this.storeSessionState(l),this.clearHashAfterLogin&&!e.preventClearHashAfterLogin&&this.clearLocationHash(),this.eventsSubject.next(new y("token_received")),this.callOnTokenReceivedIfExists(e),this.inImplicitFlow=!1,!0)).catch(c=>(this.eventsSubject.next(new p("token_validation_error",c)),this.logger.error("Error validating tokens"),this.logger.error(c),Promise.reject(c))):(this.eventsSubject.next(new y("token_received")),this.clearHashAfterLogin&&!e.preventClearHashAfterLogin&&this.clearLocationHash(),this.callOnTokenReceivedIfExists(e),Promise.resolve(!0))}parseState(e){let t=e,s="";if(e){let r=e.indexOf(this.config.nonceStateSeparator);r>-1&&(t=e.substr(0,r),s=e.substr(r+this.config.nonceStateSeparator.length))}return[t,s]}validateNonce(e){let t;return this.saveNoncesInLocalStorage&&typeof window.localStorage<"u"?t=localStorage.getItem("nonce"):t=this._storage.getItem("nonce"),t!==e?(console.error("Validating access_token failed, wrong state/nonce.",t,e),!1):!0}storeIdToken(e){this._storage.setItem("id_token",e.idToken),this._storage.setItem("id_token_claims_obj",e.idTokenClaimsJson),this._storage.setItem("id_token_expires_at",""+e.idTokenExpiresAt),this._storage.setItem("id_token_stored_at",""+this.dateTimeService.now())}storeSessionState(e){this._storage.setItem("session_state",e)}getSessionState(){return this._storage.getItem("session_state")}handleLoginError(e,t){e.onLoginError&&e.onLoginError(t),this.clearHashAfterLogin&&!e.preventClearHashAfterLogin&&this.clearLocationHash()}getClockSkewInMsec(e=6e5){return!this.clockSkewInSec&&this.clockSkewInSec!==0?e:this.clockSkewInSec*1e3}processIdToken(e,t,s=!1){let r=e.split("."),n=this.padBase64(r[0]),a=Fe(n),h=JSON.parse(a),l=this.padBase64(r[1]),m=Fe(l),c=JSON.parse(m),d;if(this.saveNoncesInLocalStorage&&typeof window.localStorage<"u"?d=localStorage.getItem("nonce"):d=this._storage.getItem("nonce"),Array.isArray(c.aud)){if(c.aud.every(g=>g!==this.clientId)){let g="Wrong audience: "+c.aud.join(",");return this.logger.warn(g),Promise.reject(g)}}else if(c.aud!==this.clientId){let g="Wrong audience: "+c.aud;return this.logger.warn(g),Promise.reject(g)}if(!c.sub){let g="No sub claim in id_token";return this.logger.warn(g),Promise.reject(g)}if(this.sessionChecksEnabled&&this.silentRefreshSubject&&this.silentRefreshSubject!==c.sub){let g=`After refreshing, we got an id_token for another user (sub). Expected sub: ${this.silentRefreshSubject}, received sub: ${c.sub}`;return this.logger.warn(g),Promise.reject(g)}if(!c.iat){let g="No iat claim in id_token";return this.logger.warn(g),Promise.reject(g)}if(!this.skipIssuerCheck&&c.iss!==this.issuer){let g="Wrong issuer: "+c.iss;return this.logger.warn(g),Promise.reject(g)}if(!s&&c.nonce!==d){let g="Wrong nonce: "+c.nonce;return this.logger.warn(g),Promise.reject(g)}if(Object.prototype.hasOwnProperty.call(this,"responseType")&&(this.responseType==="code"||this.responseType==="id_token")&&(this.disableAtHashCheck=!0),!this.disableAtHashCheck&&this.requestAccessToken&&!c.at_hash){let g="An at_hash is needed!";return this.logger.warn(g),Promise.reject(g)}let u=this.dateTimeService.now(),f=c.iat*1e3,w=c.exp*1e3,E=this.getClockSkewInMsec();if(f-E>=u||w+E-this.decreaseExpirationBySec<=u){let g="Token has expired";return console.error(g),console.error({now:u,issuedAtMSec:f,expiresAtMSec:w}),Promise.reject(g)}let I={accessToken:t,idToken:e,jwks:this.jwks,idTokenClaims:c,idTokenHeader:h,loadKeys:()=>this.loadJwks()};return this.disableAtHashCheck?this.checkSignature(I).then(()=>({idToken:e,idTokenClaims:c,idTokenClaimsJson:m,idTokenHeader:h,idTokenHeaderJson:a,idTokenExpiresAt:w})):this.checkAtHash(I).then(g=>{if(!this.disableAtHashCheck&&this.requestAccessToken&&!g){let M="Wrong at_hash";return this.logger.warn(M),Promise.reject(M)}return this.checkSignature(I).then(()=>{let M=!this.disableAtHashCheck,ce={idToken:e,idTokenClaims:c,idTokenClaimsJson:m,idTokenHeader:h,idTokenHeaderJson:a,idTokenExpiresAt:w};return M?this.checkAtHash(I).then(De=>{if(this.requestAccessToken&&!De){let he="Wrong at_hash";return this.logger.warn(he),Promise.reject(he)}else return ce}):ce})})}getIdentityClaims(){let e=this._storage.getItem("id_token_claims_obj");return e?JSON.parse(e):null}getGrantedScopes(){let e=this._storage.getItem("granted_scopes");return e?JSON.parse(e):null}getIdToken(){return this._storage?this._storage.getItem("id_token"):null}padBase64(e){for(;e.length%4!==0;)e+="=";return e}getAccessToken(){return this._storage?this._storage.getItem("access_token"):null}getRefreshToken(){return this._storage?this._storage.getItem("refresh_token"):null}getAccessTokenExpiration(){return this._storage.getItem("expires_at")?parseInt(this._storage.getItem("expires_at"),10):null}getAccessTokenStoredAt(){return parseInt(this._storage.getItem("access_token_stored_at"),10)}getIdTokenStoredAt(){return parseInt(this._storage.getItem("id_token_stored_at"),10)}getIdTokenExpiration(){return this._storage.getItem("id_token_expires_at")?parseInt(this._storage.getItem("id_token_expires_at"),10):null}hasValidAccessToken(){if(this.getAccessToken()){let e=this._storage.getItem("expires_at"),t=this.dateTimeService.new();return!(e&&parseInt(e,10)-this.decreaseExpirationBySec<t.getTime()-this.getClockSkewInMsec())}return!1}hasValidIdToken(){if(this.getIdToken()){let e=this._storage.getItem("id_token_expires_at"),t=this.dateTimeService.new();return!(e&&parseInt(e,10)-this.decreaseExpirationBySec<t.getTime()-this.getClockSkewInMsec())}return!1}getCustomTokenResponseProperty(e){return this._storage&&this.config.customTokenParameters&&this.config.customTokenParameters.indexOf(e)>=0&&this._storage.getItem(e)!==null?JSON.parse(this._storage.getItem(e)):null}authorizationHeader(){return"Bearer "+this.getAccessToken()}logOut(e={},t=""){let s=!1;typeof e=="boolean"&&(s=e,e={});let r=this.getIdToken();if(this._storage.removeItem("access_token"),this._storage.removeItem("id_token"),this._storage.removeItem("refresh_token"),this.saveNoncesInLocalStorage?(localStorage.removeItem("nonce"),localStorage.removeItem("PKCE_verifier")):(this._storage.removeItem("nonce"),this._storage.removeItem("PKCE_verifier")),this._storage.removeItem("expires_at"),this._storage.removeItem("id_token_claims_obj"),this._storage.removeItem("id_token_expires_at"),this._storage.removeItem("id_token_stored_at"),this._storage.removeItem("access_token_stored_at"),this._storage.removeItem("granted_scopes"),this._storage.removeItem("session_state"),this.config.customTokenParameters&&this.config.customTokenParameters.forEach(a=>this._storage.removeItem(a)),this.silentRefreshSubject=null,this.eventsSubject.next(new T("logout")),!this.logoutUrl||s)return;let n;if(!this.validateUrlForHttps(this.logoutUrl))throw new Error("logoutUrl  must use HTTPS (with TLS), or config value for property 'requireHttps' must be set to 'false' and allow HTTP (without TLS).");if(this.logoutUrl.indexOf("{{")>-1)n=this.logoutUrl.replace(/\{\{id_token\}\}/,encodeURIComponent(r)).replace(/\{\{client_id\}\}/,encodeURIComponent(this.clientId));else{let a=new j({encoder:new F});r&&(a=a.set("id_token_hint",r));let h=this.postLogoutRedirectUri||this.redirectUriAsPostLogoutRedirectUriFallback&&this.redirectUri||"";h&&(a=a.set("post_logout_redirect_uri",h),t&&(a=a.set("state",t)));for(let l in e)a=a.set(l,e[l]);n=this.logoutUrl+(this.logoutUrl.indexOf("?")>-1?"&":"?")+a.toString()}this.config.openUri(n)}createAndSaveNonce(){let e=this;return this.createNonce().then(function(t){return e.saveNoncesInLocalStorage&&typeof window.localStorage<"u"?localStorage.setItem("nonce",t):e._storage.setItem("nonce",t),t})}ngOnDestroy(){this.clearAccessTokenTimer(),this.clearIdTokenTimer(),this.removeSilentRefreshEventListener();let e=this.document.getElementById(this.silentRefreshIFrameName);e&&e.remove(),this.stopSessionCheckTimer(),this.removeSessionCheckEventListener();let t=this.document.getElementById(this.sessionCheckIFrameName);t&&t.remove()}createNonce(){return new Promise(e=>{if(this.rngUrl)throw new Error("createNonce with rng-web-api has not been implemented so far");let t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-._~",s=45,r="",n=typeof self>"u"?null:self.crypto||self.msCrypto;if(n){let a=new Uint8Array(s);n.getRandomValues(a),a.map||(a.map=Array.prototype.map),a=a.map(h=>t.charCodeAt(h%t.length)),r=String.fromCharCode.apply(null,a)}else for(;0<s--;)r+=t[Math.random()*t.length|0];e(Ue(r))})}checkAtHash(e){return U(this,null,function*(){return this.tokenValidationHandler?this.tokenValidationHandler.validateAtHash(e):(this.logger.warn("No tokenValidationHandler configured. Cannot check at_hash."),!0)})}checkSignature(e){return this.tokenValidationHandler?this.tokenValidationHandler.validateSignature(e):(this.logger.warn("No tokenValidationHandler configured. Cannot check signature."),Promise.resolve(null))}initLoginFlow(e="",t={}){return this.responseType==="code"?this.initCodeFlow(e,t):this.initImplicitFlow(e,t)}initCodeFlow(e="",t={}){this.loginUrl!==""?this.initCodeFlowInternal(e,t):this.events.pipe(S(s=>s.type==="discovery_document_loaded")).subscribe(()=>this.initCodeFlowInternal(e,t))}initCodeFlowInternal(e="",t={}){if(!this.validateUrlForHttps(this.loginUrl))throw new Error("loginUrl  must use HTTPS (with TLS), or config value for property 'requireHttps' must be set to 'false' and allow HTTP (without TLS).");let s={},r=null;typeof t=="string"?r=t:typeof t=="object"&&(s=t),this.createLoginUrl(e,r,null,!1,s).then(this.config.openUri).catch(n=>{console.error("Error in initAuthorizationCodeFlow"),console.error(n)})}createChallangeVerifierPairForPKCE(){return U(this,null,function*(){if(!this.crypto)throw new Error("PKCE support for code flow needs a CryptoHander. Did you import the OAuthModule using forRoot() ?");let e=yield this.createNonce(),t=yield this.crypto.calcHash(e,"sha-256");return[Ue(t),e]})}extractRecognizedCustomParameters(e){let t=new Map;return this.config.customTokenParameters&&this.config.customTokenParameters.forEach(s=>{e[s]&&t.set(s,JSON.stringify(e[s]))}),t}revokeTokenAndLogout(e={},t=!1){let s=this.revocationEndpoint,r=this.getAccessToken(),n=this.getRefreshToken();if(!r)return Promise.resolve();let a=new j({encoder:new F}),h=new P().set("Content-Type","application/x-www-form-urlencoded");if(this.useHttpBasicAuth){let l=btoa(`${this.clientId}:${this.dummyClientSecret}`);h=h.set("Authorization","Basic "+l)}if(this.useHttpBasicAuth||(a=a.set("client_id",this.clientId)),!this.useHttpBasicAuth&&this.dummyClientSecret&&(a=a.set("client_secret",this.dummyClientSecret)),this.customQueryParams)for(let l of Object.getOwnPropertyNames(this.customQueryParams))a=a.set(l,this.customQueryParams[l]);return new Promise((l,m)=>{let c,d;if(r){let u=a.set("token",r).set("token_type_hint","access_token");c=this.http.post(s,u,{headers:h})}else c=b(null);if(n){let u=a.set("token",n).set("token_type_hint","refresh_token");d=this.http.post(s,u,{headers:h})}else d=b(null);t&&(c=c.pipe(L(u=>u.status===0?b(null):B(u))),d=d.pipe(L(u=>u.status===0?b(null):B(u)))),de([c,d]).subscribe(u=>{this.logOut(e),l(u),this.logger.info("Token successfully revoked")},u=>{this.logger.error("Error revoking token",u),this.eventsSubject.next(new p("token_revoke_error",u)),m(u)})})}clearLocationHash(){location.hash!=""&&(location.hash="")}static{this.\u0275fac=function(t){return new(t||o)(v(Se),v(Ae),v(K,8),v(W,8),v(H,8),v(Le),v(Q),v(X,8),v(Ce),v(D))}}static{this.\u0275prov=C({token:o,factory:o.\u0275fac})}}return o})(),Z=class{},ne=class{handleError(i){return B(i)}},Qe=(()=>{class o{constructor(e,t,s){this.oAuthService=e,this.errorHandler=t,this.moduleConfig=s}checkUrl(e){return this.moduleConfig.resourceServer.customUrlValidation?this.moduleConfig.resourceServer.customUrlValidation(e):this.moduleConfig.resourceServer.allowedUrls?!!this.moduleConfig.resourceServer.allowedUrls.find(t=>e.toLowerCase().startsWith(t.toLowerCase())):!0}intercept(e,t){let s=e.url.toLowerCase();return!this.moduleConfig||!this.moduleConfig.resourceServer||!this.checkUrl(s)?t.handle(e):this.moduleConfig.resourceServer.sendAccessToken?ge(b(this.oAuthService.getAccessToken()).pipe(S(n=>!!n)),this.oAuthService.events.pipe(S(n=>n.type==="token_received"),ue(this.oAuthService.waitForTokenInMsec||0),L(()=>b(null)),V(()=>this.oAuthService.getAccessToken()))).pipe(ke(1),fe(n=>{if(n){let a="Bearer "+n,h=e.headers.set("Authorization",a);e=e.clone({headers:h})}return t.handle(e).pipe(L(a=>this.errorHandler.handleError(a)))})):t.handle(e).pipe(L(n=>this.errorHandler.handleError(n)))}static{this.\u0275fac=function(t){return new(t||o)(v(G),v(Z),v(z,8))}}static{this.\u0275prov=C({token:o,factory:o.\u0275fac})}}return o})();function Ke(){return console}function We(){return typeof sessionStorage<"u"?sessionStorage:new Me}function Xe(o=null,i=J){return ve([G,Le,{provide:Q,useFactory:Ke},{provide:K,useFactory:We},{provide:W,useClass:i},{provide:X,useClass:ze},{provide:Z,useClass:ne},{provide:z,useValue:o},{provide:Ee,useClass:Qe,multi:!0},{provide:D,useClass:Oe}])}var dt=(()=>{class o{static forRoot(e=null,t=J){return{ngModule:o,providers:[Xe(e,t)]}}static{this.\u0275fac=function(t){return new(t||o)}}static{this.\u0275mod=Ie({type:o})}static{this.\u0275inj=we({imports:[xe]})}}return o})();var ft=new ye("AUTH_CONFIG");var He={issuer:"https://accounts.google.com",redirectUri:window.location.origin,clientId:"49830763903-bmkvi79cd6dtlscq761v23aa17nn9jif.apps.googleusercontent.com",scope:"openid profile email",strictDiscoveryDocumentValidation:!1};var Re=class o{oathService=se(G);router=se(Pe);profile=Te(null);constructor(){}initConfiguration(){this.oathService.configure(He),this.oathService.setupAutomaticSilentRefresh(),this.oathService.loadDiscoveryDocumentAndTryLogin().then(()=>{this.oathService.hasValidAccessToken()&&this.profile.set(this.oathService.getIdentityClaims())}).catch(i=>{console.error("Error loading discovery document:",i)})}login(){this.oathService.initImplicitFlow()}logout(){this.oathService.revokeTokenAndLogout(),this.oathService.logOut(),this.profile.set(null),this.router.navigate([""])}getLoggedProfile(){return this.profile()}static \u0275fac=function(e){return new(e||o)};static \u0275prov=C({token:o,factory:o.\u0275fac,providedIn:"root"})};var x=function(o){return o[o.State=0]="State",o[o.Transition=1]="Transition",o[o.Sequence=2]="Sequence",o[o.Group=3]="Group",o[o.Animate=4]="Animate",o[o.Keyframes=5]="Keyframes",o[o.Style=6]="Style",o[o.Trigger=7]="Trigger",o[o.Reference=8]="Reference",o[o.AnimateChild=9]="AnimateChild",o[o.AnimateRef=10]="AnimateRef",o[o.Query=11]="Query",o[o.Stagger=12]="Stagger",o}(x||{}),Ze="*";function Y(o,i){return{type:x.Trigger,name:o,definitions:i,options:{}}}function A(o,i=null){return{type:x.Animate,styles:i,timings:o}}function O(o,i=null){return{type:x.Group,steps:o,options:i}}function It(o,i=null){return{type:x.Sequence,steps:o,options:i}}function k(o){return{type:x.Style,styles:o,offset:null}}function R(o,i,e=null){return{type:x.Transition,expr:o,animation:i,options:e}}function _(o,i,e=null){return{type:x.Query,selector:o,animation:i,options:e}}var oe=class{_onDoneFns=[];_onStartFns=[];_onDestroyFns=[];_originalOnDoneFns=[];_originalOnStartFns=[];_started=!1;_destroyed=!1;_finished=!1;_position=0;parentPlayer=null;totalTime;constructor(i=0,e=0){this.totalTime=i+e}_onFinish(){this._finished||(this._finished=!0,this._onDoneFns.forEach(i=>i()),this._onDoneFns=[])}onStart(i){this._originalOnStartFns.push(i),this._onStartFns.push(i)}onDone(i){this._originalOnDoneFns.push(i),this._onDoneFns.push(i)}onDestroy(i){this._onDestroyFns.push(i)}hasStarted(){return this._started}init(){}play(){this.hasStarted()||(this._onStart(),this.triggerMicrotask()),this._started=!0}triggerMicrotask(){queueMicrotask(()=>this._onFinish())}_onStart(){this._onStartFns.forEach(i=>i()),this._onStartFns=[]}pause(){}restart(){}finish(){this._onFinish()}destroy(){this._destroyed||(this._destroyed=!0,this.hasStarted()||this._onStart(),this.finish(),this._onDestroyFns.forEach(i=>i()),this._onDestroyFns=[])}reset(){this._started=!1,this._finished=!1,this._onStartFns=this._originalOnStartFns,this._onDoneFns=this._originalOnDoneFns}setPosition(i){this._position=this.totalTime?i*this.totalTime:1}getPosition(){return this.totalTime?this._position/this.totalTime:1}triggerCallback(i){let e=i=="start"?this._onStartFns:this._onDoneFns;e.forEach(t=>t()),e.length=0}},ae=class{_onDoneFns=[];_onStartFns=[];_finished=!1;_started=!1;_destroyed=!1;_onDestroyFns=[];parentPlayer=null;totalTime=0;players;constructor(i){this.players=i;let e=0,t=0,s=0,r=this.players.length;r==0?queueMicrotask(()=>this._onFinish()):this.players.forEach(n=>{n.onDone(()=>{++e==r&&this._onFinish()}),n.onDestroy(()=>{++t==r&&this._onDestroy()}),n.onStart(()=>{++s==r&&this._onStart()})}),this.totalTime=this.players.reduce((n,a)=>Math.max(n,a.totalTime),0)}_onFinish(){this._finished||(this._finished=!0,this._onDoneFns.forEach(i=>i()),this._onDoneFns=[])}init(){this.players.forEach(i=>i.init())}onStart(i){this._onStartFns.push(i)}_onStart(){this.hasStarted()||(this._started=!0,this._onStartFns.forEach(i=>i()),this._onStartFns=[])}onDone(i){this._onDoneFns.push(i)}onDestroy(i){this._onDestroyFns.push(i)}hasStarted(){return this._started}play(){this.parentPlayer||this.init(),this._onStart(),this.players.forEach(i=>i.play())}pause(){this.players.forEach(i=>i.pause())}restart(){this.players.forEach(i=>i.restart())}finish(){this._onFinish(),this.players.forEach(i=>i.finish())}destroy(){this._onDestroy()}_onDestroy(){this._destroyed||(this._destroyed=!0,this._onFinish(),this.players.forEach(i=>i.destroy()),this._onDestroyFns.forEach(i=>i()),this._onDestroyFns=[])}reset(){this.players.forEach(i=>i.reset()),this._destroyed=!1,this._finished=!1,this._started=!1}setPosition(i){let e=i*this.totalTime;this.players.forEach(t=>{let s=t.totalTime?Math.min(1,e/t.totalTime):1;t.setPosition(s)})}getPosition(){let i=this.players.reduce((e,t)=>e===null||t.totalTime>e.totalTime?t:e,null);return i!=null?i.getPosition():0}beforeDestroy(){this.players.forEach(i=>{i.beforeDestroy&&i.beforeDestroy()})}triggerCallback(i){let e=i=="start"?this._onStartFns:this._onDoneFns;e.forEach(t=>t()),e.length=0}},Ge="!";var Rt=Y("fadeAnimation",[R("* => *",[k({opacity:0}),A("0.5s ease-in-out",k({opacity:1}))])]),Dt=Y("routeAnimations",[R("landing => template",Ye()),R("template => landing",et()),R("* => *",[k({position:"relative"}),_(":enter, :leave",[k({position:"absolute",top:0,left:0,width:"100%"})],{optional:!0}),_(":enter",[k({opacity:0,transform:"translateX(100%)"})],{optional:!0}),_(":leave",[k({opacity:1,transform:"translateX(0)"})],{optional:!0}),O([_(":leave",[A("0.3s ease-out",k({opacity:0,transform:"translateX(-100%)"}))],{optional:!0}),_(":enter",[A("0.3s ease-out",k({opacity:1,transform:"translateX(0)"}))],{optional:!0})])])]);function Ye(){return[k({position:"relative"}),_(":enter, :leave",[k({position:"absolute",top:0,left:0,width:"100%"})],{optional:!0}),_(":enter",[k({opacity:0,transform:"translateX(100%)"})],{optional:!0}),_(":leave",[k({opacity:1,transform:"translateX(0)"})],{optional:!0}),O([_(":leave",[A("0.3s ease-out",k({opacity:0,transform:"translateX(-100%)"}))],{optional:!0}),_(":enter",[A("0.3s ease-out",k({opacity:1,transform:"translateX(0)"}))],{optional:!0})])]}function et(){return[k({position:"relative"}),_(":enter, :leave",[k({position:"absolute",top:0,left:0,width:"100%"})],{optional:!0}),_(":enter",[k({opacity:0,transform:"translateX(-100%)"})],{optional:!0}),_(":leave",[k({opacity:1,transform:"translateX(0)"})],{optional:!0}),O([_(":leave",[A("0.3s ease-out",k({opacity:0,transform:"translateX(100%)"}))],{optional:!0}),_(":enter",[A("0.3s ease-out",k({opacity:1,transform:"translateX(0)"}))],{optional:!0})])]}export{x as a,Ze as b,It as c,k as d,oe as e,ae as f,Ge as g,Xe as h,dt as i,Re as j,Dt as k};
